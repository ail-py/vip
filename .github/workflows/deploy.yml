name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Install Dependencies & Fix Biome Error
        run: |
          # This block fixes the biome@1.6.0 error automatically
          echo "Removing broken biome dependency..."
          npm uninstall biome --no-save || true
          
          echo "Installing correct @biomejs/biome package..."
          npm install -D @biomejs/biome
          
          echo "Installing remaining dependencies..."
          npm install

      - name: Build Wasm
        run: npm run build:wasm || wasm-pack build --target nodejs

      - name: Build Worker
        # This runs the build script if it exists
        run: |
          if grep -q "build" package.json; then
            npm run build
          fi

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
